---
title: Configure the KPI service
draft: true
description: >-
  An explanation of how to configure the KPI service to feed it with process data
weight: 200
menu:
  main:
    parent: howto-kpi-service
    identifier: configure-kpi-service
---

This guide defines the required time series tables for the KPI service to function correctly. It does not include a suggestion on how these values should be persisted. Instead see [Use cases: Calculate OEE]({{< relref "use-cases/calculate-oee" >}})

To learn how the KPI service works, read [About KPI service]({{< ref "about-kpi-service" >}})

## Prerequisites

- The KPI service is installed
- The `equipmentHierarchy` is configured

## Procedure

In short, to configure the KPI Service, the procedure works as follows:

1. Persist machine state records to the `EquipmentState` table
1. Persist quantity records to the `QuantityLog` table
1. Persist job response data to the `JobOrderState` table
1. (Optional) Configure the calendar service to record planned downtime events and shift records to timeseries. See: [Use work calendars]({{< relref "/how-to/work-calendars" >}})

## Record machine states

Every time an equipment changes state, it should be persisted to the timeseries table `EquipmentState`

### EquipmentState table schema

{{< tabs >}}
{{% tab "schema" %}}

```sql
CREATE TABLE IF NOT EXISTS EquipmentState(
  EquipmentId SYMBOL,
  ISO22400State VARCHAR, -- ADOT, AUST, ADET, APT
  time TIMESTAMP
) TIMESTAMP(time) PARTITION BY MONTH DEDUP UPSERT KEYS(time, EquipmentId);
```

{{< notice "note" >}}
The above table shows a QuestDB specific schema, the KPI service will automatically create the tables for your specific time series database on first load.
You may also add additional columns as required.
{{< /notice >}}
{{% /tab %}}
{{% tab "example" %}}

```json
[
 {
   "EquipmentId": "Machine A",
   "ISO22400State": "ADET",
   "PackMLState": "Held",
   "time": "2024-03-28T13:13:47.814086Z",
 }
]
```

{{< notice "note" >}}
The above record shows an additional field `PackMLState` to show that additional data can also be recorded.
{{< /notice >}}
{{% /tab %}}
{{< /tabs >}}

## Record quantity records

There are two categories of quantity records that may be persisted:

1. (Optional) Values generated by the machine
1. Final produced quantities (these should be categorised into Good, Scrap and Rework)

### QuantityLog table schema

{{< tabs >}}
{{% tab "schema" %}}

```sql
CREATE TABLE IF NOT EXISTS QuantityLog(
  EquipmentId SYMBOL,
  Origin SYMBOL, -- Machine, User
  QtyType SYMBOL, -- Delta, RunningTotal (running total not currently supported)
  ProductionType SYMBOL, -- Good, Scrap, Rework
  Qty FLOAT,
  time TIMESTAMP
) TIMESTAMP(time) PARTITION BY MONTH DEDUP UPSERT KEYS(time, EquipmentId, Origin, QtyType, ProductionType);
```

{{% /tab %}}
{{% tab "machine example" %}}

```json
[
 {
   "EquipmentId": "Machine A",
   "Origin": "Machine",
   "QtyType": "Delta",
   "ProductionType": "Unknown",
   "Qty": 6,
   "time": "2024-03-28T09:30:34.000325Z"
 }
]
```

{{% /tab %}}
{{% tab "user example" %}}

```json
[
 {
   "EquipmentId": "Machine A",
   "Origin": "User",
   "QtyType": "Delta",
   "ProductionType": "Good",
   "Qty": 10,
   "time": "2024-03-28T09:30:34.000325Z"
 },
{
   "EquipmentId": "Machine A",
   "Origin": "User",
   "QtyType": "Delta",
   "ProductionType": "Scrap",
   "Qty": 2,
   "time": "2024-03-28T09:30:34.000325Z"
 },
{
   "EquipmentId": "Machine A",
   "Origin": "User",
   "QtyType": "Delta",
   "ProductionType": "Rework",
   "Qty": 1,
   "time": "2024-03-28T09:30:34.000325Z"
 }
]
```

{{% /tab %}}
{{< /tabs >}}

## Record job response records

Job response records are persisted to `JobOrderState` and are used to identify the current planned cycle time of each part produced from the machine. When an operation is started, a record is created setting the planned cycle time and when the operation is finished, another record is created to reset the planned cycle time to 0.

### JobOrderState table schema

{{< tabs >}}
{{% tab "schema" %}}

```sql
CREATE TABLE IF NOT EXISTS JobOrderState(
  EquipmentId SYMBOL,
  JobOrderId SYMBOL,
  PlanningCycleTime FLOAT, -- Number of seconds per produced part
  time TIMESTAMP
) TIMESTAMP(time) PARTITION BY MONTH DEDUP UPSERT KEYS(time, EquipmentId, JobOrderId);
```

{{% /tab %}}
{{% tab "start operation" %}}

```json
[
 {
   "EquipmentId": "Machine A",
   "JobOrderId": "Order001",
   "PlanningCycleTime": 100, 
   "time": "2024-04-02T14:32:21.947000Z"
 }
]
```

{{% /tab %}}
{{% tab "end operation" %}}

```json
[
 {
   "EquipmentId": "Machine A",
   "JobOrderId": "Order001",
   "PlanningCycleTime": 0, 
   "time": "2024-04-02T14:59:58.947000Z"
 }
]
```

{{% /tab %}}
{{< /tabs >}}
